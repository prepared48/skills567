---
name: observability-design
description: 根据代码变更自动生成日志、监控、报警的设计方案，输出draw.io格式的架构图和文字描述。触发关键词：设计方案、脑图、监控方案、日志设计、报警设计。适用于代码开发完成后需要设计可观测性方案的场景。
---

# Observability Design Skill

## 概述

此skill用于分析代码变更，自动生成日志、监控、报警的设计方案，并输出draw.io格式的架构图和详细的方案描述文档。

## 工作流程

### 1. 分析代码变更

首先获取代码变更内容：

```bash
# 获取当前分支的所有变更
git diff master...HEAD

# 或者获取最近的提交
git log -1 -p
```

分析以下关键信息：
- **业务功能**：识别新增或修改的业务功能
- **关键路径**：识别核心业务流程和调用链路
- **风险点**：识别可能出现问题的地方（外部依赖、数据库操作、网络调用等）
- **性能敏感点**：识别可能影响性能的操作

### 2. 设计日志方案

基于代码分析，设计日志埋点方案。参考 [references/logging-best-practices.md](references/logging-best-practices.md) 获取详细的日志设计规范。

**日志设计要点：**
- **入口日志**：记录请求参数、用户标识
- **关键节点日志**：记录业务流程的关键步骤
- **外部调用日志**：记录RPC、HTTP、数据库调用的请求和响应
- **异常日志**：记录所有异常信息和堆栈
- **出口日志**：记录返回结果和耗时

**日志级别选择：**
- ERROR：系统错误、业务异常
- WARN：降级、重试、异常但可恢复的情况
- INFO：关键业务节点、外部调用
- DEBUG：详细的调试信息（生产环境关闭）

### 3. 设计监控方案

基于代码分析，设计监控指标方案。参考 [references/monitoring-best-practices.md](references/monitoring-best-practices.md) 获取详细的监控设计规范。

**监控指标类型：**
- **业务指标**：订单量、用户数、转化率等业务KPI
- **性能指标**：接口耗时、QPS、响应时间分位值（P50/P90/P99）
- **错误指标**：错误率、异常次数、失败率
- **资源指标**：CPU、内存、线程池、连接池使用率
- **依赖指标**：外部服务调用成功率、耗时

**监控维度：**
- 按接口/方法维度
- 按用户/租户维度
- 按环境维度（生产/预发布）
- 按错误类型维度



### 6. 输出方案描述

生成详细的文字版方案描述，包含：

**1. 代码变更概述**
- 变更的功能模块
- 涉及的核心类和方法
- 主要业务流程

**2. 日志设计方案**
- 日志埋点清单（位置、级别、内容）
- 日志格式规范
- 日志采样策略（如有）

**3. 监控设计方案**
- 监控指标清单（指标名、类型、维度）
- 监控数据采集方式
- 监控大盘设计

**4. 报警设计方案**
- 报警规则清单（条件、级别、接收人）
- 报警通知渠道
- 报警处理流程

**5. 实施建议**
- 优先级排序
- 实施步骤
- 注意事项

## 输出格式


### 方案文档
- 文件名：`{branch-name}-observability-design.md`
- 其中 `{branch-name}` 为当前git分支名
- Markdown格式，包含完整的设计方案

## 使用示例

**示例1：分析当前分支的变更**
```
用户：帮我设计一下这次代码修改的监控方案
Claude：[分析git diff，生成日志、监控、报警方案]
```

**示例2：分析指定的代码**
```
用户：这是我新写的订单服务代码，帮我生成设计方案和脑图
Claude：[分析提供的代码，生成完整的可观测性设计方案]
```

## 注意事项

1. **代码分析深度**：优先分析核心业务逻辑和高风险操作
2. **方案实用性**：确保方案可落地，避免过度设计
3. **性能影响**：考虑日志和监控对系统性能的影响
4. **成本控制**：合理设置采样率和报警阈值，避免数据爆炸
5. **团队规范**：遵循团队已有的日志、监控、报警规范
