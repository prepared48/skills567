# 报警设计最佳实践

## 报警级别定义

### P0 - 紧急（Critical）
**定义**：核心功能完全不可用，影响大量用户，需要立即处理

**触发条件示例：**
- 核心接口错误率 > 10%
- 核心接口完全不可用（QPS降为0）
- 数据库主库不可用
- 核心业务流程中断

**响应要求：**
- 立即响应（5分钟内）
- 24小时on-call
- 短信 + 电话 + 企业微信

**示例：**
```
报警名称：订单创建接口P0报警
报警条件：order.create.error_rate > 10% 持续5分钟
报警级别：P0
接收人：订单团队on-call、技术总监
通知方式：短信 + 电话 + 企业微信
```

### P1 - 重要（High）
**定义**：重要功能异常，影响部分用户，需要尽快处理

**触发条件示例：**
- 重要接口错误率 > 5%
- 重要接口响应时间 P99 > 3秒
- 从库不可用
- 缓存集群部分节点故障

**响应要求：**
- 30分钟内响应
- 工作时间on-call
- 短信 + 企业微信

**示例：**
```
报警名称：会员权益查询P1报警
报警条件：privilege.query.error_rate > 5% 持续10分钟
报警级别：P1
接收人：会员团队、值班人员
通知方式：短信 + 企业微信
```

### P2 - 一般（Medium）
**定义**：非核心功能异常，影响较小，工作时间处理

**触发条件示例：**
- 非核心接口错误率 > 3%
- 接口响应时间 P99 > 5秒
- 定时任务执行失败
- 消息队列消费延迟

**响应要求：**
- 2小时内响应
- 工作时间处理
- 企业微信

**示例：**
```
报警名称：积分计算定时任务P2报警
报警条件：points.calculate.job.fail 持续2次
报警级别：P2
接收人：积分团队
通知方式：企业微信
```

### P3 - 提示（Low）
**定义**：性能下降或潜在风险，定期review

**触发条件示例：**
- 接口响应时间 P99 > 2秒
- 资源使用率 > 70%
- 缓存命中率 < 80%
- 慢查询次数增加

**响应要求：**
- 工作时间review
- 定期优化
- 企业微信（可选）

**示例：**
```
报警名称：数据库连接池P3报警
报警条件：db.connection.usage > 70% 持续30分钟
报警级别：P3
接收人：DBA团队
通知方式：企业微信
```

## 报警规则设计

### 1. 阈值报警
基于固定阈值触发报警

**适用场景：**
- 错误率报警
- 资源使用率报警
- 响应时间报警

**示例：**
```
# 错误率报警
指标：api.error_rate
条件：> 5%
持续时间：5分钟
报警级别：P1

# CPU使用率报警
指标：system.cpu.usage
条件：> 80%
持续时间：10分钟
报警级别：P2

# 响应时间报警
指标：api.response_time.p99
条件：> 3000ms
持续时间：5分钟
报警级别：P1
```

### 2. 趋势报警
基于指标变化趋势触发报警

**适用场景：**
- QPS突降/突增
- 流量异常波动
- 业务指标异常

**示例：**
```
# QPS突降报警
指标：api.qps
条件：环比下降 > 50%
对比周期：5分钟前
报警级别：P0

# 订单量异常报警
指标：order.count
条件：同比下降 > 30%
对比周期：昨天同时段
报警级别：P1
```

### 3. 组合报警
多个条件同时满足触发报警

**适用场景：**
- 复杂故障场景
- 减少误报

**示例：**
```
# 数据库故障组合报警
条件1：db.connection.fail_rate > 10%
条件2：db.query.timeout_rate > 5%
条件3：db.connection.active > 90%
逻辑：条件1 AND (条件2 OR 条件3)
持续时间：3分钟
报警级别：P0
```

### 4. 静默期设置
避免报警风暴

**静默策略：**
- **报警间隔**：同一报警5分钟内只发送一次
- **报警收敛**：同类报警合并发送
- **维护窗口**：发布期间暂停报警
- **恢复通知**：故障恢复后发送恢复通知

**示例：**
```
报警名称：接口错误率报警
报警间隔：5分钟
收敛规则：同一接口的报警合并
维护窗口：每天02:00-04:00暂停
恢复通知：是
```

## 报警指标设计

### 1. 接口层报警

#### 错误率报警
```
指标名称：api.error_rate
计算公式：(失败请求数 / 总请求数) * 100%
报警条件：
  - P0: > 10% 持续5分钟
  - P1: > 5% 持续10分钟
  - P2: > 3% 持续15分钟
维度：接口、环境
```

#### 响应时间报警
```
指标名称：api.response_time.p99
计算公式：99分位响应时间
报警条件：
  - P0: > 5000ms 持续5分钟
  - P1: > 3000ms 持续10分钟
  - P2: > 2000ms 持续15分钟
维度：接口、环境
```

#### QPS异常报警
```
指标名称：api.qps
计算公式：每秒请求数
报警条件：
  - P0: 环比下降 > 80% 持续3分钟
  - P1: 环比下降 > 50% 持续5分钟
维度：接口、环境
```

### 2. 业务层报警

#### 订单量异常报警
```
指标名称：order.count
计算公式：单位时间订单数
报警条件：
  - P0: 同比下降 > 50% 持续10分钟
  - P1: 同比下降 > 30% 持续15分钟
对比周期：昨天同时段
维度：订单类型、渠道
```

#### 支付成功率报警
```
指标名称：payment.success_rate
计算公式：(支付成功数 / 支付总数) * 100%
报警条件：
  - P0: < 90% 持续5分钟
  - P1: < 95% 持续10分钟
维度：支付方式、环境
```

### 3. 依赖层报警

#### 数据库报警
```
# 连接池使用率
指标：db.connection.usage
报警条件：
  - P1: > 90% 持续5分钟
  - P2: > 80% 持续10分钟

# 慢查询报警
指标：db.slow_query.count
报警条件：
  - P2: > 100次/分钟 持续5分钟

# 数据库错误率
指标：db.error_rate
报警条件：
  - P0: > 5% 持续3分钟
  - P1: > 3% 持续5分钟
```

#### 缓存报警
```
# 缓存命中率
指标：cache.hit_rate
报警条件：
  - P2: < 80% 持续10分钟
  - P3: < 90% 持续15分钟

# 缓存连接失败
指标：cache.connection.fail_rate
报警条件：
  - P0: > 10% 持续3分钟
  - P1: > 5% 持续5分钟
```

#### RPC调用报警
```
# RPC成功率
指标：rpc.success_rate
报警条件：
  - P0: < 90% 持续5分钟
  - P1: < 95% 持续10分钟
维度：服务名、方法名

# RPC超时率
指标：rpc.timeout_rate
报警条件：
  - P1: > 5% 持续5分钟
  - P2: > 3% 持续10分钟
维度：服务名、方法名
```

### 4. 系统资源报警

#### CPU报警
```
指标：system.cpu.usage
报警条件：
  - P1: > 90% 持续10分钟
  - P2: > 80% 持续15分钟
  - P3: > 70% 持续30分钟
```

#### 内存报警
```
指标：jvm.memory.usage
报警条件：
  - P1: > 90% 持续10分钟
  - P2: > 85% 持续15分钟
  - P3: > 80% 持续30分钟
```

#### 线程池报警
```
# 线程池队列堆积
指标：threadpool.queue.size
报警条件：
  - P1: > 1000 持续5分钟
  - P2: > 500 持续10分钟

# 线程池拒绝次数
指标：threadpool.rejected.count
报警条件：
  - P0: > 100次/分钟 持续3分钟
  - P1: > 50次/分钟 持续5分钟
```

## 报警通知设计

### 1. 通知渠道
- **短信**：P0/P1级别报警
- **电话**：P0级别报警
- **企业微信**：所有级别报警
- **邮件**：P3级别报警或日报

### 2. 通知内容
```
【P0报警】订单创建接口异常

报警时间：2026-01-19 10:30:00
报警级别：P0 - 紧急
报警对象：/order/create
报警指标：错误率
当前值：15.6%
阈值：10%
持续时间：5分钟

影响范围：订单创建功能不可用
处理建议：
1. 检查应用日志
2. 检查数据库连接
3. 检查依赖服务

查看详情：http://monitor.example.com/alert/12345
```

### 3. 接收人配置
```
# 按团队配置
订单团队：
  - P0: 张三（主）、李四（备）
  - P1: 订单团队全员
  - P2: 订单团队值班人员

# 按模块配置
会员模块：
  - P0: 会员团队on-call
  - P1: 会员团队
  - P2: 会员团队值班人员

# 升级策略
P0报警：
  - 0分钟：发送给一线on-call
  - 10分钟未确认：升级到二线负责人
  - 20分钟未确认：升级到技术总监
```

## 报警处理流程

### 1. 报警响应
```
1. 接收报警通知
2. 确认报警（点击确认按钮）
3. 初步判断影响范围
4. 通知相关人员
5. 开始排查问题
```

### 2. 问题排查
```
1. 查看监控大盘，确认异常指标
2. 查看应用日志，定位错误原因
3. 查看依赖服务状态
4. 查看最近的代码变更
5. 查看最近的配置变更
```

### 3. 问题处理
```
1. 紧急修复（回滚、重启、降级）
2. 验证修复效果
3. 发送恢复通知
4. 记录问题和处理过程
5. 后续优化和复盘
```

## 报警优化

### 1. 减少误报
- **合理设置阈值**：基于历史数据设置阈值
- **增加持续时间**：避免瞬时波动触发报警
- **组合条件**：多个条件同时满足才报警
- **维护窗口**：发布期间暂停报警

### 2. 减少漏报
- **覆盖关键指标**：确保核心功能都有报警
- **多维度监控**：从不同角度监控同一功能
- **定期review**：定期检查报警规则是否合理

### 3. 报警收敛
- **同类报警合并**：相同原因的报警合并发送
- **报警间隔**：同一报警N分钟内只发送一次
- **报警摘要**：定期发送报警摘要而非实时通知

## 报警规则示例

### Spring Boot应用报警规则
```yaml
# 接口错误率报警
- name: api_error_rate_p0
  metric: api.error_rate
  condition: > 10%
  duration: 5m
  level: P0
  dimensions:
    - interface
    - env
  receivers:
    - oncall-team
  channels:
    - sms
    - phone
    - wechat

# 接口响应时间报警
- name: api_response_time_p1
  metric: api.response_time.p99
  condition: > 3000ms
  duration: 10m
  level: P1
  dimensions:
    - interface
    - env
  receivers:
    - dev-team
  channels:
    - sms
    - wechat

# QPS异常报警
- name: api_qps_drop_p0
  metric: api.qps
  condition: 环比下降 > 80%
  compare_period: 5m
  duration: 3m
  level: P0
  dimensions:
    - interface
    - env
  receivers:
    - oncall-team
  channels:
    - sms
    - phone
    - wechat

# 数据库连接池报警
- name: db_connection_p1
  metric: db.connection.usage
  condition: > 90%
  duration: 5m
  level: P1
  receivers:
    - dba-team
    - dev-team
  channels:
    - sms
    - wechat

# JVM内存报警
- name: jvm_memory_p2
  metric: jvm.memory.usage
  condition: > 85%
  duration: 15m
  level: P2
  receivers:
    - dev-team
  channels:
    - wechat
```

## 常见问题

### 1. 报警风暴
**原因**：一个故障触发大量报警
**解决**：
- 设置报警间隔和收敛规则
- 使用组合报警减少重复报警
- 设置维护窗口

### 2. 报警疲劳
**原因**：报警过多导致麻木
**解决**：
- 优化报警阈值，减少误报
- 合理设置报警级别
- 定期review和清理无效报警

### 3. 报警不及时
**原因**：报警延迟或漏报
**解决**：
- 优化监控数据采集频率
- 减少报警持续时间
- 增加多维度监控

### 4. 报警处理不及时
**原因**：接收人不明确或不在线
**解决**：
- 建立on-call机制
- 设置报警升级策略
- 多渠道通知（短信+电话+企业微信）
